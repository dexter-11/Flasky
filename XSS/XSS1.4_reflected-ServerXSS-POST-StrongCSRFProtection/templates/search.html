<!-- search.html -->
{% extends 'base.html' %}
{% block content %}
<h2>(⚠️ Server-side Reflected XSS)</h2>
<!-- GET search form -->
<div class="mb-4">
    <h3>Book Search via GET</h3>
    <form method="get" action="{{ url_for('search') }}" class="d-flex gap-2">
        <input name="q_get" placeholder="Search term (GET)" value="{{ request.args.get('q_get','') }}" class="form-control" style="width:280px;" required>
        <p><button class="btn btn-primary" type="submit">Search (GET)</button></p>
    </form>
</div>
<div class="spacer"></div>
<!-- POST search form -->
<div class="mb-4">
    <h3>Book Search via POST</h3>
    <form id="postSearchForm" method="POST" action="{{ url_for('search') }}" class="d-flex gap-2">
        <input name="q_post" id="q_post" placeholder="Search term (POST)" value="{{ request.form.get('q_post','') }}" style="width:280px;" class="form-control" required>
        <p><button class="btn btn-success" id="postSearchBtn" type="submit">Search (POST)</button></p>
    </form>
    <small style="color:gray;">Strong CSRF Protection in POST request via <code>X-CSRF-Header</code>.</small>
</div>

<div class="spacer"></div>
{% if q_provided %}
    <hr>
    <h4>Results for "{{ q }}" (Method: {{ method_used }})</h4>
    {% if results %}
        <ul class="list-group">
            {% for book in results %}
                <li class="list-group-item">
                    {{ book[1] or 'Unknown Title' }} by {{ book[2] or 'Unknown Author' }} ({{ book[3] or 'Unknown Year' }})
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No results found.</p>
    {% endif %}
{% endif %}

<script>
    document.getElementById('postSearchForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const csrf = document.cookie
          .split('; ')
          .find(row => row.startsWith('__Host-csrf_token='))
          ?.split('=')[1];

      const form = document.getElementById("postSearchForm");
      const formData = new FormData(form);

      const params = new URLSearchParams();
      for (const [key, value] of formData.entries()) {
        params.append(key, value);
      }

      const response = await fetch(form.action, {
        method: form.method,
        credentials: 'include',
        body: params.toString(),
        headers: {
          "X-CSRF-Header": csrf,
          "Content-Type": "application/x-www-form-urlencoded"
        }
      });

      if (response.redirected) {
        window.location.href = response.url;
        return;
      }

      const html = await response.text();
      document.open();
      document.write(html);
      document.close();
    });
</script>

{% endblock %}